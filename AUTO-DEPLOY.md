# è‡ªåŠ¨éƒ¨ç½²æŒ‡å— - ä»GitHubè·å–å˜æ›´

é˜¿é‡Œäº‘æœåŠ¡å™¨å¯ä»¥ä»GitHubè‡ªåŠ¨è·å–å¹¶éƒ¨ç½²ä»£ç ï¼Œæœ‰ä¸‰ç§æ–¹å¼ï¼š

## ğŸš€ ä¸‰ç§è‡ªåŠ¨éƒ¨ç½²æ–¹å¼

### æ–¹å¼1ï¼šæ‰‹åŠ¨è§¦å‘ï¼ˆæœ€ç®€å•ï¼‰
åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œè„šæœ¬æ‹‰å–å¹¶éƒ¨ç½²

```bash
cd /root/sifan
./auto-deploy.sh
```

**ä¼˜ç‚¹ï¼š**
- âœ… ç®€å•ç›´æ¥
- âœ… å®Œå…¨æ§åˆ¶
- âœ… ä¸éœ€è¦é¢å¤–é…ç½®

**ç¼ºç‚¹ï¼š**
- âŒ éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ

---

### æ–¹å¼2ï¼šGitHub Webhookï¼ˆæ¨èï¼‰
GitHubæ¨é€åè‡ªåŠ¨è§¦å‘æœåŠ¡å™¨éƒ¨ç½²

**å·¥ä½œæµç¨‹ï¼š**
```
ä½ æ¨é€ä»£ç  â†’ GitHub â†’ Webhooké€šçŸ¥ â†’ æœåŠ¡å™¨ â†’ è‡ªåŠ¨éƒ¨ç½²
```

**ä¼˜ç‚¹ï¼š**
- âœ… å®Œå…¨è‡ªåŠ¨
- âœ… å®æ—¶éƒ¨ç½²
- âœ… é€‚åˆå›¢é˜Ÿåä½œ

**ç¼ºç‚¹ï¼š**
- âš ï¸ éœ€è¦é…ç½®GitHub
- âš ï¸ éœ€è¦å¼€æ”¾é¢å¤–çš„3001ç«¯å£

---

### æ–¹å¼3ï¼šå®šæ—¶ä»»åŠ¡
å®šæœŸè‡ªåŠ¨æ£€æŸ¥å¹¶æ‹‰å–æœ€æ–°ä»£ç 

**ä¼˜ç‚¹ï¼š**
- âœ… è‡ªåŠ¨åŒ–
- âœ… ä¸éœ€è¦å¼€æ”¾é¢å¤–ç«¯å£
- âœ… å¯é…ç½®æ‰§è¡Œé¢‘ç‡

**ç¼ºç‚¹ï¼š**
- âŒ ä¸æ˜¯å®æ—¶éƒ¨ç½²
- âŒ ä¼šå®šæœŸæ‹‰å–ï¼Œå³ä½¿æ²¡æœ‰æ›´æ–°

---

## ğŸ“ è¯¦ç»†é…ç½®æ­¥éª¤

### æ­¥éª¤1ï¼šåœ¨æœåŠ¡å™¨ä¸Šä¸Šä¼ æ–‡ä»¶

**æ–¹æ³•Aï¼šä»GitHubæ‹‰å–ï¼ˆæ¨èï¼‰**
```bash
cd /root/sifan
git pull origin main
```

**æ–¹æ³•Bï¼šæ‰‹åŠ¨ä¸Šä¼ **
```bash
# åœ¨æœ¬åœ°ç”µè„‘æ‰§è¡Œ
scp auto-deploy.sh webhook-server.js ecosystem-webhook.config.js setup-auto-deploy.sh root@42.121.218.14:/root/sifan/
```

### æ­¥éª¤2ï¼šè¿è¡Œè®¾ç½®è„šæœ¬

```bash
cd /root/sifan
chmod +x setup-auto-deploy.sh
./setup-auto-deploy.sh
```

è„šæœ¬ä¼šå¼•å¯¼ä½ å®Œæˆï¼š
- âœ… é…ç½®GitHubè®¿é—®
- âœ… æµ‹è¯•è‡ªåŠ¨éƒ¨ç½²
- âœ… è®¾ç½®WebhookæœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰
- âœ… é…ç½®å®šæ—¶ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰

### æ­¥éª¤3ï¼šé€‰æ‹©éƒ¨ç½²æ–¹å¼

#### é€‰é¡¹Aï¼šä»…ä½¿ç”¨æ‰‹åŠ¨éƒ¨ç½²
```bash
# æ¯æ¬¡éœ€è¦æ›´æ–°æ—¶
cd /root/sifan
./auto-deploy.sh
```

#### é€‰é¡¹Bï¼šé…ç½®Webhookè‡ªåŠ¨éƒ¨ç½²

**åœ¨é˜¿é‡Œäº‘å®‰å…¨ç»„å¼€æ”¾3001ç«¯å£ï¼š**
- åè®®ç±»å‹ï¼šè‡ªå®šä¹‰TCP
- ç«¯å£èŒƒå›´ï¼š3001/3001
- æˆæƒå¯¹è±¡ï¼š0.0.0.0/0

**åœ¨GitHubé…ç½®Webhookï¼š**
1. è®¿é—®ï¼šhttps://github.com/MFCR7788/sifan/settings/hooks
2. ç‚¹å‡» "Add webhook"
3. å¡«å†™ï¼š
   - Payload URL: `http://42.121.218.14:3001/webhook`
   - Content type: `application/json`
   - Secret: `sifan-webhook-secret-2026`
   - å‹¾é€‰: Just the push event
4. ç‚¹å‡» "Add webhook"

#### é€‰é¡¹Cï¼šé…ç½®å®šæ—¶ä»»åŠ¡

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /root/sifan

# æ·»åŠ æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡çš„ä»»åŠ¡
(crontab -l 2>/dev/null; echo "0 * * * * cd /root/sifan && ./auto-deploy.sh >> /root/sifan/logs/auto-deploy.log 2>&1") | crontab -

# æŸ¥çœ‹å®šæ—¶ä»»åŠ¡
crontab -l
```

---

## ğŸ”§ è„šæœ¬è¯´æ˜

### auto-deploy.sh
è‡ªåŠ¨éƒ¨ç½²æ ¸å¿ƒè„šæœ¬ï¼Œä¼šæ‰§è¡Œï¼š
1. âœ… æ‹‰å–æœ€æ–°ä»£ç 
2. âœ… æ£€æµ‹nginx.confå˜æ›´å¹¶æ›´æ–°
3. âœ… æ£€æµ‹package.jsonå˜æ›´å¹¶é‡æ–°å®‰è£…ä¾èµ–
4. âœ… æ£€æµ‹ä»£ç å˜æ›´å¹¶é‡å¯PM2åº”ç”¨
5. âœ… éªŒè¯æœåŠ¡æ­£å¸¸

### webhook-server.js
WebhookæœåŠ¡å™¨ï¼Œç›‘å¬GitHubæ¨é€äº‹ä»¶ï¼š
- ç«¯å£ï¼š3001
- è·¯å¾„ï¼š`/webhook`
- å®‰å…¨ï¼šç­¾åéªŒè¯ï¼ˆå¯é…ç½®Secretï¼‰

### setup-auto-deploy.sh
ä¸€é”®è®¾ç½®è„šæœ¬ï¼Œè‡ªåŠ¨é…ç½®æ‰€æœ‰ç»„ä»¶ã€‚

---

## ğŸ“Š è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµç¨‹

### å½“ä½ æ¨é€ä»£ç æ—¶

```
1. æœ¬åœ°å¼€å‘
   git add .
   git commit -m "update"
   git push origin main

2. GitHubè§¦å‘
   â†’ Webhookå‘é€é€šçŸ¥ï¼ˆå¦‚æœé…ç½®äº†ï¼‰

3. æœåŠ¡å™¨æ¥æ”¶
   â†’ webhook-server.jsæ¥æ”¶é€šçŸ¥

4. è‡ªåŠ¨éƒ¨ç½²
   â†’ auto-deploy.shæ‰§è¡Œ
   â†’ æ‹‰å–ä»£ç 
   â†’ æ›´æ–°é…ç½®
   â†’ é‡å¯æœåŠ¡

5. éƒ¨ç½²å®Œæˆ
   â†’ è®°å½•æ—¥å¿—
   â†’ è®¿é—®éªŒè¯
```

---

## ğŸ” æŸ¥çœ‹æ—¥å¿—

### æŸ¥çœ‹Webhookæ—¥å¿—
```bash
pm2 logs webhook-server
```

### æŸ¥çœ‹è‡ªåŠ¨éƒ¨ç½²æ—¥å¿—
```bash
tail -f /root/sifan/logs/auto-deploy.log
```

### æŸ¥çœ‹PM2æ—¥å¿—
```bash
pm2 logs enterprise-website
```

---

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

### æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
```bash
cd /root/sifan && ./auto-deploy.sh
```

### æŸ¥çœ‹å®šæ—¶ä»»åŠ¡
```bash
crontab -l
```

### åˆ é™¤å®šæ—¶ä»»åŠ¡
```bash
crontab -e
# åˆ é™¤å¯¹åº”çš„è¡Œï¼Œä¿å­˜é€€å‡º
```

### é‡å¯WebhookæœåŠ¡å™¨
```bash
pm2 restart webhook-server
```

### åœæ­¢WebhookæœåŠ¡å™¨
```bash
pm2 stop webhook-server
pm2 delete webhook-server
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å®‰å…¨å»ºè®®
1. **é…ç½®Webhook Secret**ï¼šä¸è¦ä½¿ç”¨é»˜è®¤å¯†é’¥
2. **é™åˆ¶ç«¯å£è®¿é—®**ï¼š3001ç«¯å£å¯ä»¥ä»…å¯¹GitHub IPå¼€æ”¾
3. **ä½¿ç”¨HTTPS**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½®SSLè¯ä¹¦

### GitHub Token
ä¸ºäº†é¿å…æ¯æ¬¡æ‹‰å–éƒ½è¾“å…¥å¯†ç ï¼Œå»ºè®®é…ç½®Personal Access Tokenï¼š
1. è®¿é—®ï¼šhttps://github.com/settings/tokens
2. åˆ›å»ºTokenï¼Œå‹¾é€‰ `repo` æƒé™
3. ä½¿ç”¨Tokené…ç½®è¿œç¨‹URL

### é˜²ç«å¢™
å¦‚æœä½¿ç”¨Webhookï¼Œéœ€è¦å¼€æ”¾3001ç«¯å£ï¼š
```bash
sudo firewall-cmd --permanent --add-port=3001/tcp
sudo firewall-cmd --reload
```

---

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### å¼€å‘ç¯å¢ƒ
- ä½¿ç”¨**æ‰‹åŠ¨éƒ¨ç½²**æˆ–**å®šæ—¶ä»»åŠ¡**
- ç®€å•å¿«é€Ÿï¼Œä¸éœ€è¦å¼€æ”¾é¢å¤–ç«¯å£

### ç”Ÿäº§ç¯å¢ƒ
- ä½¿ç”¨**GitHub Webhook** + **å®šæ—¶ä»»åŠ¡**å…œåº•
- å®æ—¶éƒ¨ç½²ï¼Œæœ‰å®¹é”™æœºåˆ¶

### å›¢é˜Ÿåä½œ
- å¿…é¡»ä½¿ç”¨**GitHub Webhook**
- æ¯æ¬¡æ¨é€è‡ªåŠ¨éƒ¨ç½²ï¼Œä¿æŒåŒæ­¥

---

## ğŸ“¦ æ–‡ä»¶æ¸…å•

éƒ¨ç½²éœ€è¦çš„æ–‡ä»¶ï¼š
- âœ… `auto-deploy.sh` - è‡ªåŠ¨éƒ¨ç½²è„šæœ¬
- âœ… `webhook-server.js` - WebhookæœåŠ¡å™¨
- âœ… `ecosystem-webhook.config.js` - PM2é…ç½®
- âœ… `setup-auto-deploy.sh` - ä¸€é”®è®¾ç½®è„šæœ¬

---

## ğŸ‰ é…ç½®å®Œæˆåçš„å·¥ä½œæµ

### æ—¥å¸¸æ›´æ–°
```bash
# æœ¬åœ°å¼€å‘
git add .
git commit -m "update"
git push origin main

# æœåŠ¡å™¨è‡ªåŠ¨éƒ¨ç½²ï¼ˆå¦‚æœé…ç½®äº†Webhookï¼‰
# æˆ–
# æ‰‹åŠ¨æ‰§è¡Œï¼šssh root@42.121.218.14 'cd /root/sifan && ./auto-deploy.sh'
```

### æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
```bash
# åœ¨æœåŠ¡å™¨ä¸Š
pm2 status
pm2 logs webhook-server --lines 50
```

---

## ğŸ†˜ æ•…éšœæ’æŸ¥

### Webhookä¸è§¦å‘
1. æ£€æŸ¥GitHub Webhooké…ç½®æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥3001ç«¯å£æ˜¯å¦å¼€æ”¾
3. æ£€æŸ¥webhook-serveræ˜¯å¦è¿è¡Œï¼š`pm2 status`

### ä»£ç æ‹‰å–å¤±è´¥
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. æ£€æŸ¥GitHub Tokenæ˜¯å¦æœ‰æ•ˆ
3. æ£€æŸ¥SSHå¯†é’¥æˆ–æƒé™

### Nginxé…ç½®ä¸ç”Ÿæ•ˆ
1. æ£€æŸ¥nginx.confè¯­æ³•ï¼š`sudo nginx -t`
2. æ£€æŸ¥æ–‡ä»¶æƒé™ï¼š`ls -la /etc/nginx/conf.d/`

---

## ğŸ“ å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
2. æ£€æŸ¥PM2çŠ¶æ€ï¼š`pm2 status`
3. é‡å¯æœåŠ¡ï¼š`pm2 restart all`

ç°åœ¨å¼€å§‹é…ç½®å§ï¼ğŸš€
