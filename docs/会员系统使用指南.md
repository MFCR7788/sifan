# 会员系统使用指南

## 概述

本会员系统支持完整的会员管理功能，包括会员注册、登录、充值、消费、积分管理等核心功能。

## 数据库设计

### 1. members 表（会员信息表）

| 字段名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| id | varchar(36) | 会员ID（主键） | gen_random_uuid() |
| user_id | varchar(36) | 用户ID（外键，关联users表） | 必填 |
| member_level | varchar(50) | 会员等级（basic/silver/gold/platinum/diamond） | 'basic' |
| balance | integer | 余额（单位：分） | 0 |
| points | integer | 积分 | 0 |
| total_recharge | integer | 累计充值金额（单位：分） | 0 |
| total_consumption | integer | 累计消费金额（单位：分） | 0 |
| member_status | varchar(50) | 会员状态（active/suspended/expired） | 'active' |
| expires_at | timestamp | 会员过期时间 | 可空 |
| metadata | jsonb | 会员元数据 | 可空 |
| created_at | timestamp | 创建时间 | now() |
| updated_at | timestamp | 更新时间 | 可空 |

### 2. member_transactions 表（会员交易记录表）

| 字段名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| id | varchar(36) | 交易ID（主键） | gen_random_uuid() |
| member_id | varchar(36) | 会员ID（外键，关联members表） | 必填 |
| transaction_type | varchar(50) | 交易类型（recharge/consumption/refund/points_adjust） | 必填 |
| amount | integer | 交易金额（单位：分） | 必填 |
| balance_before | integer | 交易前余额 | 必填 |
| balance_after | integer | 交易后余额 | 必填 |
| points_before | integer | 交易前积分 | 0 |
| points_after | integer | 交易后积分 | 0 |
| description | varchar(500) | 交易描述 | 可空 |
| status | varchar(50) | 交易状态（pending/completed/failed/cancelled） | 'pending' |
| payment_method | varchar(50) | 支付方式（alipay/wechat/balance等） | 可空 |
| payment_transaction_id | varchar(255) | 支付平台交易ID | 可空 |
| metadata | jsonb | 交易元数据 | 可空 |
| created_at | timestamp | 创建时间 | now() |
| updated_at | timestamp | 更新时间 | 可空 |
| completed_at | timestamp | 完成时间 | 可空 |

## 使用方法

### 导入

```typescript
import { memberManager, memberTransactionManager } from "@/storage/database";
import type {
  Member,
  InsertMember,
  UpdateMember,
  MemberTransaction,
} from "@/storage/database";
```

### 基础操作

#### 1. 创建会员

```typescript
const member = await memberManager.createMember({
  userId: "user-uuid",
  memberLevel: "basic",
  balance: 0,
  points: 0,
});
```

#### 2. 获取会员信息

```typescript
// 根据用户ID获取会员
const member = await memberManager.getMemberByUserId("user-uuid");

// 根据会员ID获取会员
const member = await memberManager.getMemberById("member-uuid");
```

#### 3. 更新会员信息

```typescript
const updatedMember = await memberManager.updateMember("member-uuid", {
  memberLevel: "gold",
  memberStatus: "active",
});
```

#### 4. 获取会员列表

```typescript
const members = await memberManager.getMembers({
  skip: 0,
  limit: 20,
  filters: {
    memberLevel: "basic",
    memberStatus: "active",
  },
});
```

### 充值功能

```typescript
// 充值（单位：分）
const updatedMember = await memberManager.recharge(
  "member-uuid",
  10000, // 充值100元（10000分）
  "账户充值",
  "alipay", // 支付方式
  "payment-transaction-id-123", // 支付平台交易ID
);
```

### 消费功能

```typescript
// 消费（单位：分）
const updatedMember = await memberManager.consume(
  "member-uuid",
  5000, // 消费50元（5000分）
  "购买商品",
  { orderId: "order-123" }, // 元数据
);
```

### 积分管理

```typescript
// 增加积分
const updatedMember = await memberManager.addPoints(
  "member-uuid",
  100, // 增加100积分
  "订单完成奖励",
  { orderId: "order-123" },
);

// 扣减积分
const updatedMember = await memberManager.deductPoints(
  "member-uuid",
  50, // 扣减50积分
  "积分兑换商品",
  { productId: "product-123" },
);
```

### 会员等级升级

```typescript
const updatedMember = await memberManager.upgradeLevel(
  "member-uuid",
  "platinum", // 升级为白金会员
);
```

### 获取会员统计信息

```typescript
const stats = await memberManager.getMemberStats("member-uuid");
// 返回：
// {
//   memberId: "member-uuid",
//   balance: 50000,
//   points: 1000,
//   totalRecharge: 100000,
//   totalConsumption: 50000,
//   memberLevel: "gold",
//   memberStatus: "active",
//   transactionCount: 15,
//   rechargeCount: 5,
//   consumptionCount: 10,
//   refundCount: 0,
// }
```

### 交易记录查询

```typescript
// 获取会员的交易记录
const transactions = await memberTransactionManager.getTransactionsByMemberId(
  "member-uuid",
  {
    skip: 0,
    limit: 20,
    filters: {
      transactionType: "recharge",
      status: "completed",
    },
  },
);

// 获取交易统计
const stats = await memberTransactionManager.getTransactionStats("member-uuid");
```

## 会员等级体系

| 等级 | 名称 | 说明 |
|------|------|------|
| basic | 基础会员 | 默认等级 |
| silver | 银牌会员 | 中等等级 |
| gold | 金牌会员 | 高级等级 |
| platinum | 白金会员 | 超高级等级 |
| diamond | 钻石会员 | 最高等级 |

## 交易类型

| 类型 | 说明 |
|------|------|
| recharge | 充值 |
| consumption | 消费 |
| refund | 退款 |
| points_adjust | 积分调整 |

## 交易状态

| 状态 | 说明 |
|------|------|
| pending | 待处理 |
| completed | 已完成 |
| failed | 失败 |
| cancelled | 已取消 |

## 支付方式

| 方式 | 说明 |
|------|------|
| alipay | 支付宝 |
| wechat | 微信支付 |
| balance | 余额支付 |
| bank | 银行卡 |

## 注意事项

1. **金额单位**：所有金额都以"分"为单位，100分 = 1元
2. **余额不足**：消费时会检查余额，余额不足会抛出异常
3. **会员状态**：只有 active 状态的会员才能进行消费
4. **等级升级**：只能从低等级向高等级升级
5. **积分管理**：积分不足时会抛出异常
6. **事务安全**：充值和消费操作会自动创建交易记录，确保数据一致性

## API 集成示例

### 会员充值 API

```typescript
// src/app/api/members/recharge/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { memberManager } from '@/storage/database';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { memberId, amount, paymentMethod, paymentTransactionId } = body;

    const member = await memberManager.recharge(
      memberId,
      amount,
      '账户充值',
      paymentMethod,
      paymentTransactionId,
    );

    return NextResponse.json({ success: true, data: member });
  } catch (error) {
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 400 }
    );
  }
}
```

### 会员消费 API

```typescript
// src/app/api/members/consume/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { memberManager } from '@/storage/database';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { memberId, amount, description } = body;

    const member = await memberManager.consume(
      memberId,
      amount,
      description,
    );

    return NextResponse.json({ success: true, data: member });
  } catch (error) {
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 400 }
    );
  }
}
```

## 后续扩展建议

1. **会员权益系统**：为不同等级会员设置不同的折扣、优惠券等权益
2. **积分商城**：实现积分兑换商品功能
3. **会员卡系统**：支持实体会员卡和虚拟会员卡
4. **会员活动**：创建会员专属活动，提升用户粘性
5. **推荐奖励**：实现会员推荐新用户获得奖励的功能
6. **自动升级**：根据消费金额或积分自动升级会员等级
7. **会员过期**：实现会员过期和续费功能
