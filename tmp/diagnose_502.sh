#!/bin/bash

################################################################################
# 502 错误诊断脚本
# 用途：诊断并修复 Nginx 502 错误
################################################################################

echo "========================================"
echo "  502 错误诊断工具"
echo "========================================"
echo ""

# 1. 检查 PM2 服务状态
echo "1. 检查 PM2 服务状态..."
pm2 status

echo ""
echo "========================================"
echo ""

# 2. 检查 Node.js 进程
echo "2. 检查 Node.js 进程..."
ps aux | grep node | grep -v grep

echo ""
echo "========================================"
echo ""

# 3. 检查端口 3000
echo "3. 检查端口 3000 是否监听..."
netstat -tunlp | grep 3000 || echo "端口 3000 未监听"

echo ""
echo "========================================"
echo ""

# 4. 检查 Nginx 配置
echo "4. 检查 Nginx 配置..."
nginx -t

echo ""
echo "========================================"
echo ""

# 5. 检查 Nginx 状态
echo "5. 检查 Nginx 状态..."
systemctl status nginx

echo ""
echo "========================================"
echo ""

# 6. 查看 PM2 日志
echo "6. 查看 PM2 最近日志..."
pm2 logs sifan --lines 20 --nostream

echo ""
echo "========================================"
echo ""

# 7. 查看 Nginx 错误日志
echo "7. 查看 Nginx 错误日志..."
tail -n 20 /var/log/nginx/error.log

echo ""
echo "========================================"
echo ""

# 8. 测试本地连接
echo "8. 测试本地连接到端口 3000..."
curl -I http://localhost:3000/ || echo "无法连接到 localhost:3000"

echo ""
echo "========================================"
echo ""
